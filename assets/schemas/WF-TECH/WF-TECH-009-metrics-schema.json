{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "WIRTHFORGE Metrics Schema",
  "description": "Comprehensive schema for WIRTHFORGE observability metrics including latency, frame stability, progression rate, error counts, and energy fidelity",
  "version": "1.0.0",
  "type": "object",
  "definitions": {
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp with millisecond precision"
    },
    "duration_ms": {
      "type": "number",
      "minimum": 0,
      "description": "Duration in milliseconds"
    },
    "percentage": {
      "type": "number",
      "minimum": 0,
      "maximum": 100,
      "description": "Percentage value between 0 and 100"
    },
    "energy_units": {
      "type": "number",
      "minimum": 0,
      "description": "Energy units as defined in WF-FND-002"
    },
    "frame_rate": {
      "type": "number",
      "minimum": 0,
      "maximum": 120,
      "description": "Frames per second, target is 60Hz"
    }
  },
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0"
    },
    "session_id": {
      "type": "string",
      "pattern": "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$",
      "description": "UUID v4 session identifier"
    },
    "timestamp": {
      "$ref": "#/definitions/timestamp"
    },
    "metrics": {
      "type": "object",
      "properties": {
        "latency": {
          "type": "object",
          "description": "End-to-end latency metrics from prompt to response",
          "properties": {
            "prompt_to_response_ms": {
              "$ref": "#/definitions/duration_ms",
              "description": "Total time from prompt submission to final token rendered"
            },
            "model_computation_ms": {
              "$ref": "#/definitions/duration_ms",
              "description": "Time spent in AI model computation"
            },
            "decipher_processing_ms": {
              "$ref": "#/definitions/duration_ms",
              "description": "Time spent in DECIPHER processing pipeline"
            },
            "ui_render_ms": {
              "$ref": "#/definitions/duration_ms",
              "description": "Time spent rendering response in UI"
            },
            "p50_latency_ms": {
              "$ref": "#/definitions/duration_ms",
              "description": "50th percentile latency over measurement window"
            },
            "p95_latency_ms": {
              "$ref": "#/definitions/duration_ms",
              "description": "95th percentile latency (governance target: <2000ms)"
            },
            "p99_latency_ms": {
              "$ref": "#/definitions/duration_ms",
              "description": "99th percentile latency"
            },
            "average_latency_ms": {
              "$ref": "#/definitions/duration_ms",
              "description": "Average latency over measurement window"
            }
          },
          "required": ["prompt_to_response_ms", "p95_latency_ms", "average_latency_ms"]
        },
        "frame_stability": {
          "type": "object",
          "description": "60Hz frame processing stability metrics",
          "properties": {
            "current_fps": {
              "$ref": "#/definitions/frame_rate",
              "description": "Current frames per second"
            },
            "average_fps": {
              "$ref": "#/definitions/frame_rate",
              "description": "Average FPS over measurement window"
            },
            "frame_drops_count": {
              "type": "integer",
              "minimum": 0,
              "description": "Number of frames that exceeded 16.67ms budget"
            },
            "frame_drops_percentage": {
              "$ref": "#/definitions/percentage",
              "description": "Percentage of frames dropped in measurement window"
            },
            "longest_frame_ms": {
              "$ref": "#/definitions/duration_ms",
              "description": "Longest frame processing time in window"
            },
            "frame_budget_violations": {
              "type": "integer",
              "minimum": 0,
              "description": "Frames exceeding 16.67ms target budget"
            },
            "frame_stability_score": {
              "$ref": "#/definitions/percentage",
              "description": "Overall frame stability score (100% = perfect 60Hz)"
            }
          },
          "required": ["current_fps", "average_fps", "frame_drops_count", "frame_stability_score"]
        },
        "progression_rate": {
          "type": "object",
          "description": "User progression and engagement metrics",
          "properties": {
            "current_level": {
              "type": "integer",
              "minimum": 1,
              "description": "Current user level in WIRTHFORGE progression system"
            },
            "experience_points": {
              "type": "integer",
              "minimum": 0,
              "description": "Current experience points"
            },
            "levels_per_hour": {
              "type": "number",
              "minimum": 0,
              "description": "Rate of level progression per hour"
            },
            "xp_per_minute": {
              "type": "number",
              "minimum": 0,
              "description": "Experience points gained per minute"
            },
            "session_duration_minutes": {
              "type": "number",
              "minimum": 0,
              "description": "Current session duration in minutes"
            },
            "total_sessions": {
              "type": "integer",
              "minimum": 0,
              "description": "Total number of sessions"
            },
            "progression_velocity": {
              "type": "string",
              "enum": ["too_slow", "optimal", "too_fast"],
              "description": "Progression rate assessment for game balance"
            }
          },
          "required": ["current_level", "experience_points", "levels_per_hour", "progression_velocity"]
        },
        "error_counts": {
          "type": "object",
          "description": "System reliability and error tracking",
          "properties": {
            "total_errors": {
              "type": "integer",
              "minimum": 0,
              "description": "Total errors in measurement window"
            },
            "errors_per_minute": {
              "type": "number",
              "minimum": 0,
              "description": "Error rate per minute"
            },
            "critical_errors": {
              "type": "integer",
              "minimum": 0,
              "description": "Critical system errors requiring attention"
            },
            "plugin_errors": {
              "type": "integer",
              "minimum": 0,
              "description": "Errors from plugin modules"
            },
            "model_errors": {
              "type": "integer",
              "minimum": 0,
              "description": "AI model computation errors"
            },
            "ui_errors": {
              "type": "integer",
              "minimum": 0,
              "description": "User interface rendering errors"
            },
            "network_errors": {
              "type": "integer",
              "minimum": 0,
              "description": "Local network/WebSocket errors"
            },
            "uptime_percentage": {
              "$ref": "#/definitions/percentage",
              "description": "System uptime percentage"
            },
            "mean_time_between_failures_minutes": {
              "type": "number",
              "minimum": 0,
              "description": "MTBF in minutes"
            }
          },
          "required": ["total_errors", "errors_per_minute", "uptime_percentage"]
        },
        "energy_fidelity": {
          "type": "object",
          "description": "Energy visualization truth and accuracy metrics",
          "properties": {
            "visual_energy_units": {
              "$ref": "#/definitions/energy_units",
              "description": "Energy units displayed in visualization"
            },
            "computed_energy_units": {
              "$ref": "#/definitions/energy_units",
              "description": "Actual energy units computed by system"
            },
            "fidelity_ratio": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Ratio of visualized to computed energy (1.0 = perfect)"
            },
            "fidelity_percentage": {
              "$ref": "#/definitions/percentage",
              "description": "Energy fidelity as percentage (target: >90%)"
            },
            "particle_count": {
              "type": "integer",
              "minimum": 0,
              "description": "Number of energy particles currently rendered"
            },
            "token_to_particle_ratio": {
              "type": "number",
              "minimum": 0,
              "description": "Ratio of tokens processed to particles displayed"
            },
            "visual_lag_ms": {
              "$ref": "#/definitions/duration_ms",
              "description": "Lag between computation and visual representation"
            },
            "energy_coherence_score": {
              "$ref": "#/definitions/percentage",
              "description": "Overall coherence of energy visualization"
            }
          },
          "required": ["fidelity_ratio", "fidelity_percentage", "visual_lag_ms", "energy_coherence_score"]
        },
        "resource_utilization": {
          "type": "object",
          "description": "System resource usage metrics",
          "properties": {
            "cpu_usage_percentage": {
              "$ref": "#/definitions/percentage",
              "description": "Current CPU utilization"
            },
            "memory_usage_mb": {
              "type": "number",
              "minimum": 0,
              "description": "Memory usage in megabytes"
            },
            "memory_usage_percentage": {
              "$ref": "#/definitions/percentage",
              "description": "Memory utilization percentage"
            },
            "gpu_usage_percentage": {
              "$ref": "#/definitions/percentage",
              "description": "GPU utilization if available"
            },
            "disk_io_mb_per_sec": {
              "type": "number",
              "minimum": 0,
              "description": "Disk I/O rate in MB/s"
            },
            "network_io_kb_per_sec": {
              "type": "number",
              "minimum": 0,
              "description": "Network I/O rate in KB/s (local only)"
            }
          },
          "required": ["cpu_usage_percentage", "memory_usage_mb", "memory_usage_percentage"]
        },
        "throughput": {
          "type": "object",
          "description": "System throughput and processing metrics",
          "properties": {
            "tokens_per_second": {
              "type": "number",
              "minimum": 0,
              "description": "Token processing rate"
            },
            "prompts_per_minute": {
              "type": "number",
              "minimum": 0,
              "description": "Prompt processing rate"
            },
            "total_tokens_processed": {
              "type": "integer",
              "minimum": 0,
              "description": "Total tokens processed in session"
            },
            "total_prompts_processed": {
              "type": "integer",
              "minimum": 0,
              "description": "Total prompts processed in session"
            },
            "queue_depth": {
              "type": "integer",
              "minimum": 0,
              "description": "Current processing queue depth"
            },
            "backpressure_events": {
              "type": "integer",
              "minimum": 0,
              "description": "Number of backpressure events"
            }
          },
          "required": ["tokens_per_second", "prompts_per_minute", "total_tokens_processed"]
        }
      },
      "required": ["latency", "frame_stability", "progression_rate", "error_counts", "energy_fidelity"]
    },
    "alerts": {
      "type": "array",
      "description": "Active alerts and warnings",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique alert identifier"
          },
          "type": {
            "type": "string",
            "enum": ["warning", "critical", "info"],
            "description": "Alert severity level"
          },
          "metric": {
            "type": "string",
            "description": "Metric that triggered the alert"
          },
          "threshold": {
            "type": "number",
            "description": "Threshold value that was exceeded"
          },
          "current_value": {
            "type": "number",
            "description": "Current value of the metric"
          },
          "message": {
            "type": "string",
            "description": "Human-readable alert message"
          },
          "timestamp": {
            "$ref": "#/definitions/timestamp"
          },
          "duration_ms": {
            "$ref": "#/definitions/duration_ms",
            "description": "How long the condition has persisted"
          },
          "auto_resolved": {
            "type": "boolean",
            "description": "Whether alert can auto-resolve when condition clears"
          }
        },
        "required": ["id", "type", "metric", "message", "timestamp"]
      }
    },
    "metadata": {
      "type": "object",
      "description": "Metadata about the metrics collection",
      "properties": {
        "collection_interval_ms": {
          "$ref": "#/definitions/duration_ms",
          "description": "Interval between metric collections"
        },
        "measurement_window_seconds": {
          "type": "integer",
          "minimum": 1,
          "description": "Time window for aggregated metrics"
        },
        "wirthforge_version": {
          "type": "string",
          "description": "WIRTHFORGE version that collected metrics"
        },
        "system_info": {
          "type": "object",
          "properties": {
            "os": {
              "type": "string",
              "description": "Operating system"
            },
            "cpu_cores": {
              "type": "integer",
              "minimum": 1,
              "description": "Number of CPU cores"
            },
            "total_memory_mb": {
              "type": "number",
              "minimum": 0,
              "description": "Total system memory in MB"
            },
            "gpu_available": {
              "type": "boolean",
              "description": "Whether GPU acceleration is available"
            }
          }
        }
      },
      "required": ["collection_interval_ms", "measurement_window_seconds", "wirthforge_version"]
    }
  },
  "required": ["schema_version", "session_id", "timestamp", "metrics", "metadata"]
}
