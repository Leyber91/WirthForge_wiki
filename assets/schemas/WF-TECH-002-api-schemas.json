{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "WIRTHFORGE Local AI Integration API Schemas",
  "description": "JSON Schema definitions for WF-TECH-002 Local AI Integration & Turbo/Broker",
  "version": "1.0.0",
  "api_version": "1.0.0",
  "definitions": {
    "timestamp": {
      "type": "integer",
      "description": "Unix timestamp in milliseconds",
      "minimum": 0
    },
    "sessionId": {
      "type": "string",
      "description": "Unique session identifier",
      "pattern": "^[a-zA-Z0-9_-]+$"
    },
    "modelName": {
      "type": "string",
      "description": "Model identifier",
      "pattern": "^[a-zA-Z0-9_.-]+$"
    },
    "energyValue": {
      "type": "number",
      "description": "Energy unit value (0-1)",
      "minimum": 0,
      "maximum": 1
    },
    "hardwareTier": {
      "type": "string",
      "enum": ["Low-Tier", "Mid-Tier", "High-Tier", "Hybrid"],
      "description": "Hardware capability classification"
    }
  },
  "endpoints": {
    "/models": {
      "GET": {
        "description": "List available local models and their status",
        "response": {
          "type": "object",
          "properties": {
            "models": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": {
                    "$ref": "#/definitions/modelName"
                  },
                  "size_gb": {
                    "type": "number",
                    "minimum": 0
                  },
                  "status": {
                    "type": "string",
                    "enum": ["loaded", "available", "downloading", "error"]
                  },
                  "last_used": {
                    "type": "string",
                    "format": "date-time"
                  },
                  "memory_usage_mb": {
                    "type": "number",
                    "minimum": 0
                  },
                  "capabilities": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "enum": ["text-generation", "embeddings", "chat", "code"]
                    }
                  },
                  "tier_requirements": {
                    "$ref": "#/definitions/hardwareTier"
                  },
                  "performance_metrics": {
                    "type": "object",
                    "properties": {
                      "tps_average": {"type": "number", "minimum": 0},
                      "ttft_ms": {"type": "number", "minimum": 0},
                      "energy_efficiency": {"type": "number", "minimum": 0, "maximum": 1}
                    }
                  }
                },
                "required": ["name", "size_gb", "status", "tier_requirements"],
                "additionalProperties": false
              }
            },
            "total_memory_gb": {
              "type": "number",
              "minimum": 0
            },
            "available_memory_gb": {
              "type": "number",
              "minimum": 0
            },
            "hardware_tier": {
              "$ref": "#/definitions/hardwareTier"
            }
          },
          "required": ["models", "total_memory_gb", "available_memory_gb", "hardware_tier"],
          "additionalProperties": false
        }
      }
    },
    "/models/load": {
      "POST": {
        "description": "Load a model into memory",
        "request": {
          "type": "object",
          "properties": {
            "name": {
              "$ref": "#/definitions/modelName"
            },
            "priority": {
              "type": "string",
              "enum": ["low", "normal", "high"],
              "default": "normal"
            },
            "warm_up": {
              "type": "boolean",
              "default": true,
              "description": "Whether to warm up model after loading"
            },
            "tier_override": {
              "$ref": "#/definitions/hardwareTier",
              "description": "Override hardware tier detection"
            }
          },
          "required": ["name"],
          "additionalProperties": false
        },
        "response": {
          "type": "object",
          "properties": {
            "success": {"type": "boolean"},
            "model": {"$ref": "#/definitions/modelName"},
            "load_time_ms": {"type": "number", "minimum": 0},
            "memory_allocated_mb": {"type": "number", "minimum": 0},
            "tier_used": {"$ref": "#/definitions/hardwareTier"}
          },
          "required": ["success", "model"],
          "additionalProperties": false
        }
      }
    },
    "/generate": {
      "POST": {
        "description": "Start token generation stream with energy tracking",
        "request": {
          "type": "object",
          "properties": {
            "model": {
              "$ref": "#/definitions/modelName"
            },
            "prompt": {
              "type": "string",
              "minLength": 1,
              "maxLength": 10000
            },
            "mode": {
              "type": "string",
              "enum": ["single", "turbo", "council"],
              "default": "single"
            },
            "models": {
              "type": "array",
              "items": {"$ref": "#/definitions/modelName"},
              "description": "For turbo/council mode only",
              "minItems": 2,
              "maxItems": 6
            },
            "parameters": {
              "type": "object",
              "properties": {
                "temperature": {"type": "number", "minimum": 0, "maximum": 2, "default": 0.7},
                "top_p": {"type": "number", "minimum": 0, "maximum": 1, "default": 0.9},
                "top_k": {"type": "integer", "minimum": 1, "maximum": 100, "default": 40},
                "max_tokens": {"type": "integer", "minimum": 1, "maximum": 4096, "default": 512},
                "stop": {"type": "array", "items": {"type": "string"}, "maxItems": 10}
              },
              "additionalProperties": false
            },
            "energy_tracking": {
              "type": "object",
              "properties": {
                "enabled": {"type": "boolean", "default": true},
                "frame_rate": {"type": "number", "minimum": 30, "maximum": 120, "default": 60},
                "smoothing": {"type": "number", "minimum": 0, "maximum": 1, "default": 0.1}
              },
              "additionalProperties": false
            }
          },
          "required": ["model", "prompt"],
          "additionalProperties": false
        },
        "response": {
          "type": "object",
          "properties": {
            "session_id": {"$ref": "#/definitions/sessionId"},
            "stream_url": {"type": "string", "format": "uri"},
            "estimated_tokens": {"type": "integer", "minimum": 0},
            "mode": {"type": "string", "enum": ["single", "turbo", "council"]},
            "models_active": {"type": "array", "items": {"$ref": "#/definitions/modelName"}}
          },
          "required": ["session_id", "stream_url", "mode"],
          "additionalProperties": false
        }
      }
    },
    "/stop": {
      "POST": {
        "description": "Stop active generation session",
        "request": {
          "type": "object",
          "properties": {
            "session_id": {"$ref": "#/definitions/sessionId"}
          },
          "required": ["session_id"],
          "additionalProperties": false
        },
        "response": {
          "type": "object",
          "properties": {
            "success": {"type": "boolean"},
            "tokens_generated": {"type": "integer", "minimum": 0},
            "duration_ms": {"type": "number", "minimum": 0},
            "energy_consumed": {"$ref": "#/definitions/energyValue"},
            "final_stats": {
              "type": "object",
              "properties": {
                "tps_average": {"type": "number", "minimum": 0},
                "ttft_ms": {"type": "number", "minimum": 0}
              }
            }
          },
          "required": ["success"],
          "additionalProperties": false
        }
      }
    },
    "/stats": {
      "GET": {
        "description": "Get real-time performance statistics and energy metrics",
        "response": {
          "type": "object",
          "properties": {
            "timestamp": {"$ref": "#/definitions/timestamp"},
            "models": {
              "type": "object",
              "patternProperties": {
                "^[a-zA-Z0-9_.-]+$": {
                  "type": "object",
                  "properties": {
                    "tps_current": {"type": "number", "minimum": 0},
                    "tps_average": {"type": "number", "minimum": 0},
                    "ttft_ms": {"type": "number", "minimum": 0},
                    "energy_rate": {"$ref": "#/definitions/energyValue"},
                    "active_sessions": {"type": "integer", "minimum": 0},
                    "total_tokens": {"type": "integer", "minimum": 0},
                    "memory_usage_mb": {"type": "number", "minimum": 0}
                  },
                  "additionalProperties": false
                }
              },
              "additionalProperties": false
            },
            "system": {
              "type": "object",
              "properties": {
                "fps_current": {"type": "number", "minimum": 0},
                "fps_average": {"type": "number", "minimum": 0},
                "memory_usage_percent": {"type": "number", "minimum": 0, "maximum": 100},
                "cpu_usage_percent": {"type": "number", "minimum": 0, "maximum": 100},
                "active_models": {"type": "integer", "minimum": 0},
                "hardware_tier": {"$ref": "#/definitions/hardwareTier"}
              },
              "required": ["fps_current", "active_models", "hardware_tier"],
              "additionalProperties": false
            },
            "turbo": {
              "type": "object",
              "properties": {
                "active_ensembles": {"type": "integer", "minimum": 0},
                "diversity_index": {"type": "number", "minimum": 0, "maximum": 1},
                "ensemble_energy": {"$ref": "#/definitions/energyValue"},
                "sync_latency_ms": {"type": "number", "minimum": 0},
                "council_coherence": {"type": "number", "minimum": 0, "maximum": 1}
              },
              "additionalProperties": false
            }
          },
          "required": ["timestamp", "models", "system"],
          "additionalProperties": false
        }
      }
    }
  },
  "events": {
    "token_generated": {
      "description": "Emitted for each generated token with energy calculation",
      "schema": {
        "type": "object",
        "properties": {
          "session_id": {"$ref": "#/definitions/sessionId"},
          "token": {"type": "string"},
          "timestamp_ms": {"$ref": "#/definitions/timestamp"},
          "delta_ms": {"type": "integer", "minimum": 0},
          "model": {"$ref": "#/definitions/modelName"},
          "energy": {"$ref": "#/definitions/energyValue"},
          "logprobs": {
            "type": "array",
            "items": {"type": "number"},
            "description": "Token log probabilities for energy calculation"
          },
          "metadata": {
            "type": "object",
            "properties": {
              "position": {"type": "integer", "minimum": 0},
              "is_final": {"type": "boolean"},
              "entropy": {"type": "number", "minimum": 0},
              "top_k_diversity": {"type": "number", "minimum": 0, "maximum": 1}
            },
            "additionalProperties": false
          }
        },
        "required": ["session_id", "token", "timestamp_ms", "model", "energy"],
        "additionalProperties": false
      }
    },
    "ensemble_token": {
      "description": "Emitted for turbo ensemble tokens with multi-model coordination",
      "schema": {
        "type": "object",
        "properties": {
          "session_id": {"$ref": "#/definitions/sessionId"},
          "tokens": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "token": {"type": "string"},
                "model": {"$ref": "#/definitions/modelName"},
                "energy": {"$ref": "#/definitions/energyValue"},
                "confidence": {"type": "number", "minimum": 0, "maximum": 1},
                "logprobs": {"type": "array", "items": {"type": "number"}}
              },
              "required": ["token", "model", "energy", "confidence"],
              "additionalProperties": false
            }
          },
          "ensemble_energy": {"$ref": "#/definitions/energyValue"},
          "diversity_index": {"type": "number", "minimum": 0, "maximum": 1},
          "timestamp_ms": {"$ref": "#/definitions/timestamp"},
          "interference_pattern": {
            "type": "string",
            "enum": ["constructive", "destructive", "neutral"]
          }
        },
        "required": ["session_id", "tokens", "ensemble_energy", "timestamp_ms"],
        "additionalProperties": false
      }
    },
    "frame_update": {
      "description": "60Hz frame update with aggregated energy metrics",
      "schema": {
        "type": "object",
        "properties": {
          "frame_id": {"type": "integer", "minimum": 0},
          "timestamp_ms": {"$ref": "#/definitions/timestamp"},
          "energy_values": {
            "type": "array",
            "items": {"$ref": "#/definitions/energyValue"},
            "description": "Energy values for active models"
          },
          "active_sessions": {"type": "integer", "minimum": 0},
          "system_health": {
            "type": "object",
            "properties": {
              "fps": {"type": "number", "minimum": 0},
              "memory_usage": {"type": "number", "minimum": 0, "maximum": 100},
              "model_count": {"type": "integer", "minimum": 0},
              "frame_budget_ms": {"type": "number", "minimum": 0},
              "processing_time_ms": {"type": "number", "minimum": 0}
            },
            "required": ["fps", "model_count"],
            "additionalProperties": false
          }
        },
        "required": ["frame_id", "timestamp_ms", "energy_values", "system_health"],
        "additionalProperties": false
      }
    }
  },
  "error_codes": {
    "MODEL_NOT_FOUND": {
      "code": 404,
      "message": "Requested model not available",
      "recoverable": true
    },
    "MODEL_LOAD_FAILED": {
      "code": 500,
      "message": "Failed to load model into memory",
      "recoverable": true
    },
    "INSUFFICIENT_MEMORY": {
      "code": 507,
      "message": "Not enough memory to load model",
      "recoverable": false
    },
    "SESSION_NOT_FOUND": {
      "code": 404,
      "message": "Generation session not found",
      "recoverable": false
    },
    "TIER_LIMIT_EXCEEDED": {
      "code": 429,
      "message": "Hardware tier resource limits exceeded",
      "recoverable": true
    },
    "TURBO_NOT_AVAILABLE": {
      "code": 403,
      "message": "Turbo mode not available for current tier",
      "recoverable": false
    },
    "OLLAMA_CONNECTION_FAILED": {
      "code": 503,
      "message": "Failed to connect to Ollama server",
      "recoverable": true
    },
    "ENERGY_CALCULATION_ERROR": {
      "code": 500,
      "message": "Error calculating token energy values",
      "recoverable": true
    }
  }
}
