{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://wirthforge.com/schemas/billing-models.json",
  "title": "WIRTHFORGE Billing Models Schema",
  "description": "Schema defining billing calculation models, energy measurement, usage tracking, and transparent billing structures for WIRTHFORGE platform",
  "type": "object",
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version following semantic versioning"
    },
    "last_updated": {
      "type": "string",
      "format": "date-time",
      "description": "Timestamp of last schema update"
    },
    "billing_engine_config": {
      "type": "object",
      "properties": {
        "calculation_frequency": {
          "type": "string",
          "enum": ["real_time", "hourly", "daily", "weekly", "monthly"],
          "description": "How often billing calculations are performed"
        },
        "local_storage_path": {
          "type": "string",
          "description": "Local SQLite database path for billing data"
        },
        "privacy_mode": {
          "type": "string",
          "enum": ["strict", "standard", "minimal"],
          "description": "Privacy level for billing data handling"
        },
        "audit_trail_enabled": {
          "type": "boolean",
          "description": "Whether to maintain detailed audit trail"
        },
        "encryption_enabled": {
          "type": "boolean",
          "description": "Whether billing data is encrypted at rest"
        }
      },
      "required": ["calculation_frequency", "local_storage_path", "privacy_mode"],
      "additionalProperties": false
    },
    "energy_measurement": {
      "type": "object",
      "properties": {
        "measurement_units": {
          "type": "object",
          "properties": {
            "base_unit": {
              "type": "string",
              "enum": ["EU", "kWh", "joules"],
              "description": "Base unit for energy measurement"
            },
            "conversion_factors": {
              "type": "object",
              "patternProperties": {
                "^[a-zA-Z_]+$": {
                  "type": "number",
                  "minimum": 0,
                  "description": "Conversion factor to base unit"
                }
              }
            },
            "precision": {
              "type": "integer",
              "minimum": 1,
              "maximum": 10,
              "description": "Decimal places for energy measurements"
            }
          },
          "required": ["base_unit", "precision"],
          "additionalProperties": false
        },
        "component_tracking": {
          "type": "object",
          "properties": {
            "cpu_monitoring": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean"
                },
                "sampling_rate_ms": {
                  "type": "integer",
                  "minimum": 100,
                  "maximum": 10000
                },
                "power_model": {
                  "type": "string",
                  "enum": ["linear", "quadratic", "lookup_table", "hardware_specific"]
                },
                "baseline_power_watts": {
                  "type": "number",
                  "minimum": 0
                }
              },
              "required": ["enabled"],
              "additionalProperties": false
            },
            "gpu_monitoring": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean"
                },
                "sampling_rate_ms": {
                  "type": "integer",
                  "minimum": 100,
                  "maximum": 10000
                },
                "power_model": {
                  "type": "string",
                  "enum": ["nvidia_ml", "amd_adl", "intel_gpu", "generic"]
                },
                "memory_tracking": {
                  "type": "boolean"
                }
              },
              "required": ["enabled"],
              "additionalProperties": false
            },
            "memory_monitoring": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean"
                },
                "power_per_gb_watts": {
                  "type": "number",
                  "minimum": 0
                },
                "include_cache": {
                  "type": "boolean"
                }
              },
              "required": ["enabled"],
              "additionalProperties": false
            },
            "storage_monitoring": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean"
                },
                "read_power_per_gb": {
                  "type": "number",
                  "minimum": 0
                },
                "write_power_per_gb": {
                  "type": "number",
                  "minimum": 0
                },
                "idle_power_watts": {
                  "type": "number",
                  "minimum": 0
                }
              },
              "required": ["enabled"],
              "additionalProperties": false
            }
          },
          "required": ["cpu_monitoring", "gpu_monitoring", "memory_monitoring", "storage_monitoring"],
          "additionalProperties": false
        },
        "aggregation_rules": {
          "type": "object",
          "properties": {
            "time_windows": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["1min", "5min", "15min", "1hour", "1day", "1week", "1month"]
              }
            },
            "aggregation_methods": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["sum", "average", "max", "min", "median", "percentile_95"]
              }
            },
            "retention_policy": {
              "type": "object",
              "properties": {
                "raw_data_days": {
                  "type": "integer",
                  "minimum": 1
                },
                "aggregated_data_days": {
                  "type": "integer",
                  "minimum": 30
                },
                "summary_data_days": {
                  "type": "integer",
                  "minimum": 365
                }
              },
              "required": ["raw_data_days", "aggregated_data_days"],
              "additionalProperties": false
            }
          },
          "required": ["time_windows", "aggregation_methods", "retention_policy"],
          "additionalProperties": false
        }
      },
      "required": ["measurement_units", "component_tracking", "aggregation_rules"],
      "additionalProperties": false
    },
    "billing_calculations": {
      "type": "object",
      "properties": {
        "subscription_billing": {
          "type": "object",
          "properties": {
            "proration_method": {
              "type": "string",
              "enum": ["daily", "hourly", "none"],
              "description": "How to prorate subscription charges for partial periods"
            },
            "billing_cycle_anchor": {
              "type": "string",
              "enum": ["signup_date", "calendar_month", "custom"],
              "description": "When billing cycles start"
            },
            "grace_period_days": {
              "type": "integer",
              "minimum": 0,
              "maximum": 30,
              "description": "Grace period for failed payments"
            },
            "auto_renewal": {
              "type": "boolean",
              "description": "Default auto-renewal setting"
            }
          },
          "required": ["proration_method", "billing_cycle_anchor"],
          "additionalProperties": false
        },
        "usage_billing": {
          "type": "object",
          "properties": {
            "calculation_method": {
              "type": "string",
              "enum": ["linear", "tiered", "volume_discount", "peak_pricing"],
              "description": "Method for calculating usage charges"
            },
            "minimum_charge": {
              "type": "number",
              "minimum": 0,
              "description": "Minimum charge for usage billing"
            },
            "rounding_rules": {
              "type": "object",
              "properties": {
                "energy_units": {
                  "type": "string",
                  "enum": ["round_up", "round_down", "round_nearest", "no_rounding"]
                },
                "currency": {
                  "type": "string",
                  "enum": ["round_up", "round_down", "round_nearest", "banker_rounding"]
                },
                "minimum_increment": {
                  "type": "number",
                  "minimum": 0.01
                }
              },
              "required": ["energy_units", "currency"],
              "additionalProperties": false
            },
            "overage_thresholds": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "threshold_percentage": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 2,
                    "description": "Threshold as percentage of allocation (1.0 = 100%)"
                  },
                  "notification_required": {
                    "type": "boolean"
                  },
                  "rate_multiplier": {
                    "type": "number",
                    "minimum": 0,
                    "description": "Multiplier applied to base rate at this threshold"
                  }
                },
                "required": ["threshold_percentage", "notification_required", "rate_multiplier"],
                "additionalProperties": false
              }
            }
          },
          "required": ["calculation_method", "rounding_rules"],
          "additionalProperties": false
        },
        "marketplace_billing": {
          "type": "object",
          "properties": {
            "commission_calculation": {
              "type": "string",
              "enum": ["gross_revenue", "net_revenue", "transaction_fee"],
              "description": "Basis for commission calculation"
            },
            "payout_schedule": {
              "type": "string",
              "enum": ["immediate", "weekly", "monthly", "quarterly"],
              "description": "How often creators are paid"
            },
            "minimum_payout": {
              "type": "number",
              "minimum": 0,
              "description": "Minimum amount before payout is triggered"
            },
            "hold_period_days": {
              "type": "integer",
              "minimum": 0,
              "maximum": 90,
              "description": "Days to hold funds before payout"
            },
            "refund_handling": {
              "type": "object",
              "properties": {
                "commission_reversal": {
                  "type": "boolean",
                  "description": "Whether commission is reversed on refunds"
                },
                "creator_liability": {
                  "type": "boolean",
                  "description": "Whether creator is liable for refund costs"
                }
              },
              "required": ["commission_reversal", "creator_liability"],
              "additionalProperties": false
            }
          },
          "required": ["commission_calculation", "payout_schedule", "refund_handling"],
          "additionalProperties": false
        }
      },
      "required": ["subscription_billing", "usage_billing", "marketplace_billing"],
      "additionalProperties": false
    },
    "transparency_reporting": {
      "type": "object",
      "properties": {
        "real_time_dashboard": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "update_frequency_seconds": {
              "type": "integer",
              "minimum": 1,
              "maximum": 300
            },
            "metrics_displayed": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["current_usage", "daily_total", "monthly_total", "cost_estimate", "tier_progress", "component_breakdown"]
              }
            },
            "alerts_enabled": {
              "type": "boolean"
            }
          },
          "required": ["enabled", "metrics_displayed"],
          "additionalProperties": false
        },
        "monthly_statements": {
          "type": "object",
          "properties": {
            "auto_generation": {
              "type": "boolean"
            },
            "detailed_breakdown": {
              "type": "boolean",
              "description": "Include component-level energy breakdown"
            },
            "comparison_to_previous": {
              "type": "boolean",
              "description": "Include comparison to previous month"
            },
            "efficiency_insights": {
              "type": "boolean",
              "description": "Include optimization suggestions"
            },
            "export_formats": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["pdf", "csv", "json", "html"]
              }
            }
          },
          "required": ["auto_generation", "export_formats"],
          "additionalProperties": false
        },
        "audit_capabilities": {
          "type": "object",
          "properties": {
            "transaction_history": {
              "type": "boolean",
              "description": "Maintain complete transaction history"
            },
            "calculation_verification": {
              "type": "boolean",
              "description": "Allow verification of billing calculations"
            },
            "data_export": {
              "type": "boolean",
              "description": "Allow export of billing data"
            },
            "third_party_audit": {
              "type": "boolean",
              "description": "Support for third-party billing audits"
            }
          },
          "required": ["transaction_history", "calculation_verification"],
          "additionalProperties": false
        }
      },
      "required": ["real_time_dashboard", "monthly_statements", "audit_capabilities"],
      "additionalProperties": false
    },
    "payment_integration": {
      "type": "object",
      "properties": {
        "supported_processors": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "processor_name": {
                "type": "string",
                "enum": ["stripe", "paypal", "apple_pay", "google_pay", "bank_transfer", "crypto"]
              },
              "supported_currencies": {
                "type": "array",
                "items": {
                  "type": "string",
                  "pattern": "^[A-Z]{3}$"
                }
              },
              "transaction_fees": {
                "type": "object",
                "properties": {
                  "percentage": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 0.1
                  },
                  "fixed_fee": {
                    "type": "number",
                    "minimum": 0
                  },
                  "currency": {
                    "type": "string",
                    "pattern": "^[A-Z]{3}$"
                  }
                },
                "required": ["percentage", "fixed_fee", "currency"],
                "additionalProperties": false
              },
              "processing_time": {
                "type": "string",
                "description": "Typical processing time (e.g., 'instant', '1-3 days', '5-7 days')"
              }
            },
            "required": ["processor_name", "supported_currencies", "transaction_fees"],
            "additionalProperties": false
          }
        },
        "security_requirements": {
          "type": "object",
          "properties": {
            "pci_compliance": {
              "type": "boolean"
            },
            "encryption_standard": {
              "type": "string",
              "enum": ["AES-256", "RSA-2048", "ECC-P256"]
            },
            "token_storage": {
              "type": "string",
              "enum": ["local_encrypted", "processor_vault", "hardware_security"]
            },
            "fraud_detection": {
              "type": "boolean"
            }
          },
          "required": ["pci_compliance", "encryption_standard", "token_storage"],
          "additionalProperties": false
        },
        "retry_logic": {
          "type": "object",
          "properties": {
            "max_attempts": {
              "type": "integer",
              "minimum": 1,
              "maximum": 10
            },
            "backoff_strategy": {
              "type": "string",
              "enum": ["linear", "exponential", "fixed"]
            },
            "retry_intervals": {
              "type": "array",
              "items": {
                "type": "integer",
                "minimum": 1
              },
              "description": "Retry intervals in seconds"
            }
          },
          "required": ["max_attempts", "backoff_strategy"],
          "additionalProperties": false
        }
      },
      "required": ["supported_processors", "security_requirements", "retry_logic"],
      "additionalProperties": false
    },
    "compliance_settings": {
      "type": "object",
      "properties": {
        "gdpr_compliance": {
          "type": "object",
          "properties": {
            "data_minimization": {
              "type": "boolean",
              "description": "Only collect necessary billing data"
            },
            "consent_tracking": {
              "type": "boolean",
              "description": "Track user consent for billing data processing"
            },
            "right_to_erasure": {
              "type": "boolean",
              "description": "Support data deletion requests"
            },
            "data_portability": {
              "type": "boolean",
              "description": "Support data export requests"
            }
          },
          "required": ["data_minimization", "consent_tracking"],
          "additionalProperties": false
        },
        "local_regulations": {
          "type": "object",
          "patternProperties": {
            "^[A-Z]{2}$": {
              "type": "object",
              "properties": {
                "tax_calculation": {
                  "type": "boolean",
                  "description": "Whether to calculate local taxes"
                },
                "invoice_requirements": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "description": "Required invoice fields for this region"
                },
                "data_residency": {
                  "type": "boolean",
                  "description": "Whether billing data must remain in region"
                }
              },
              "additionalProperties": false
            }
          }
        }
      },
      "required": ["gdpr_compliance"],
      "additionalProperties": false
    }
  },
  "required": ["schema_version", "billing_engine_config", "energy_measurement", "billing_calculations", "transparency_reporting", "payment_integration", "compliance_settings"],
  "additionalProperties": false
}
