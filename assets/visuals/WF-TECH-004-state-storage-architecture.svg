<?xml version="1.0" encoding="UTF-8"?>
<svg viewBox="0 0 1200 800" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="dbGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#4d96ff;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#74b3ff;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="eventGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#6bcf7f;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#96e6a1;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="snapshotGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#ffd93d;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ffe66d;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="auditGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#ff6b6b;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ff8e8e;stop-opacity:1" />
    </linearGradient>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ffffff" />
    </marker>
    <filter id="glow">
      <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
      <feMerge> 
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>
  
  <!-- Background -->
  <rect width="1200" height="800" fill="#0a0a0a"/>
  
  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" fill="#ffffff" font-family="Arial, sans-serif" font-size="22" font-weight="bold">
    WF-TECH-004: State Storage & Management Architecture
  </text>
  
  <!-- SQLite Database Core -->
  <rect x="450" y="70" width="300" height="150" fill="url(#dbGrad)" rx="15" stroke="#ffffff" stroke-width="3" filter="url(#glow)"/>
  <text x="600" y="105" text-anchor="middle" fill="#ffffff" font-family="Arial, sans-serif" font-size="18" font-weight="bold">
    SQLite Database
  </text>
  <text x="600" y="125" text-anchor="middle" fill="#ffffff" font-family="Arial, sans-serif" font-size="14">
    Local-First Storage
  </text>
  <text x="600" y="145" text-anchor="middle" fill="#ffffff" font-family="Arial, sans-serif" font-size="12">
    • ACID Transactions
  </text>
  <text x="600" y="160" text-anchor="middle" fill="#ffffff" font-family="Arial, sans-serif" font-size="12">
    • Foreign Key Constraints
  </text>
  <text x="600" y="175" text-anchor="middle" fill="#ffffff" font-family="Arial, sans-serif" font-size="12">
    • JSON Support & WAL Mode
  </text>
  <text x="600" y="190" text-anchor="middle" fill="#ffffff" font-family="Arial, sans-serif" font-size="12">
    • Version 1.0.0 Schema
  </text>
  <text x="600" y="205" text-anchor="middle" fill="#ffffff" font-family="Arial, sans-serif" font-size="12">
    • Auto-vacuum & Performance Tuning
  </text>
  
  <!-- Event Sourcing -->
  <rect x="50" y="280" width="280" height="200" fill="url(#eventGrad)" rx="12"/>
  <text x="190" y="310" text-anchor="middle" fill="#000000" font-family="Arial, sans-serif" font-size="16" font-weight="bold">
    Event Sourcing Log
  </text>
  <text x="190" y="330" text-anchor="middle" fill="#000000" font-family="Arial, sans-serif" font-size="14">
    Immutable Event Stream
  </text>
  
  <!-- Event Types -->
  <rect x="70" y="345" width="240" height="125" fill="#1a1a1a" rx="8"/>
  <text x="190" y="365" text-anchor="middle" fill="#6bcf7f" font-family="Arial, sans-serif" font-size="13" font-weight="bold">
    Event Types
  </text>
  <text x="80" y="380" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • system.start / system.end
  </text>
  <text x="80" y="395" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • energy.update / energy.peak
  </text>
  <text x="80" y="410" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • user.prompt / ai.output
  </text>
  <text x="80" y="425" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • pattern.interference / pattern.resonance
  </text>
  <text x="80" y="440" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • health.heartbeat / error.occurred
  </text>
  <text x="80" y="455" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • Full JSON payload with metadata
  </text>
  
  <!-- State Snapshots -->
  <rect x="870" y="280" width="280" height="200" fill="url(#snapshotGrad)" rx="12"/>
  <text x="1010" y="310" text-anchor="middle" fill="#000000" font-family="Arial, sans-serif" font-size="16" font-weight="bold">
    State Snapshots
  </text>
  <text x="1010" y="330" text-anchor="middle" fill="#000000" font-family="Arial, sans-serif" font-size="14">
    Crash Recovery Points
  </text>
  
  <!-- Snapshot Details -->
  <rect x="890" y="345" width="240" height="125" fill="#1a1a1a" rx="8"/>
  <text x="1010" y="365" text-anchor="middle" fill="#ffd93d" font-family="Arial, sans-serif" font-size="13" font-weight="bold">
    Snapshot Components
  </text>
  <text x="900" y="380" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • Frame State (ephemeral 60Hz)
  </text>
  <text x="900" y="395" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • Energy Accumulator (session totals)
  </text>
  <text x="900" y="410" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • Session Context (user/hardware)
  </text>
  <text x="900" y="425" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • Performance Metrics
  </text>
  <text x="900" y="440" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • Recovery Context & Event IDs
  </text>
  <text x="900" y="455" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • Compressed JSON serialization
  </text>
  
  <!-- Schema Tables -->
  <rect x="380" y="280" width="180" height="200" fill="#2a2a2a" rx="10" stroke="#4d96ff" stroke-width="2"/>
  <text x="470" y="305" text-anchor="middle" fill="#4d96ff" font-family="Arial, sans-serif" font-size="14" font-weight="bold">
    Database Schema
  </text>
  
  <!-- Table list -->
  <text x="390" y="325" fill="#ffffff" font-family="Arial, sans-serif" font-size="11" font-weight="bold">
    Core Tables:
  </text>
  <text x="390" y="340" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • user (profiles & progress)
  </text>
  <text x="390" y="355" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • session (metadata & timing)
  </text>
  <text x="390" y="370" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • event (sourcing log)
  </text>
  <text x="390" y="385" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • snapshot (recovery points)
  </text>
  <text x="390" y="400" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • audit (compliance trail)
  </text>
  <text x="390" y="415" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • schema_info (versioning)
  </text>
  
  <text x="390" y="440" fill="#ffffff" font-family="Arial, sans-serif" font-size="11" font-weight="bold">
    Features:
  </text>
  <text x="390" y="455" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Auto-increment triggers
  </text>
  <text x="390" y="470" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Energy accumulation
  </text>
  
  <!-- Audit Trail -->
  <rect x="50" y="520" width="280" height="160" fill="url(#auditGrad)" rx="12"/>
  <text x="190" y="550" text-anchor="middle" fill="#ffffff" font-family="Arial, sans-serif" font-size="16" font-weight="bold">
    Audit Trail
  </text>
  <text x="190" y="570" text-anchor="middle" fill="#ffffff" font-family="Arial, sans-serif" font-size="14">
    Compliance & Security
  </text>
  
  <!-- Audit Details -->
  <rect x="70" y="585" width="240" height="85" fill="#1a1a1a" rx="8"/>
  <text x="190" y="605" text-anchor="middle" fill="#ff6b6b" font-family="Arial, sans-serif" font-size="13" font-weight="bold">
    Audit Capabilities
  </text>
  <text x="80" y="620" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • Sensitive operation logging
  </text>
  <text x="80" y="635" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • Before/after value tracking
  </text>
  <text x="80" y="650" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • User context & timestamps
  </text>
  <text x="80" y="665" fill="#ffffff" font-family="Arial, sans-serif" font-size="11">
    • Tamper-proof integrity checks
  </text>
  
  <!-- Performance & Migration -->
  <rect x="380" y="520" width="440" height="160" fill="#2a2a2a" rx="12" stroke="#9966ff" stroke-width="2"/>
  <text x="600" y="550" text-anchor="middle" fill="#9966ff" font-family="Arial, sans-serif" font-size="16" font-weight="bold">
    Performance & Migration
  </text>
  
  <!-- Performance Metrics -->
  <rect x="400" y="565" width="180" height="105" fill="#1a1a1a" rx="8"/>
  <text x="490" y="585" text-anchor="middle" fill="#9966ff" font-family="Arial, sans-serif" font-size="12" font-weight="bold">
    Performance Targets
  </text>
  <text x="410" y="600" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • 60 FPS write performance
  </text>
  <text x="410" y="615" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • &lt;1ms typical query time
  </text>
  <text x="410" y="630" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Bounded memory usage
  </text>
  <text x="410" y="645" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Graceful degradation
  </text>
  <text x="410" y="660" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Auto-cleanup policies
  </text>
  
  <!-- Migration & Versioning -->
  <rect x="600" y="565" width="200" height="105" fill="#1a1a1a" rx="8"/>
  <text x="700" y="585" text-anchor="middle" fill="#9966ff" font-family="Arial, sans-serif" font-size="12" font-weight="bold">
    Schema Evolution
  </text>
  <text x="610" y="600" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Semantic versioning
  </text>
  <text x="610" y="615" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Backward compatibility
  </text>
  <text x="610" y="630" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Migration templates
  </text>
  <text x="610" y="645" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Rollback procedures
  </text>
  <text x="610" y="660" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Data integrity validation
  </text>
  
  <!-- Backup & Recovery -->
  <rect x="870" y="520" width="280" height="160" fill="#2a2a2a" rx="12" stroke="#ff9f40" stroke-width="2"/>
  <text x="1010" y="550" text-anchor="middle" fill="#ff9f40" font-family="Arial, sans-serif" font-size="16" font-weight="bold">
    Backup & Recovery
  </text>
  
  <!-- Backup Details -->
  <rect x="890" y="565" width="240" height="105" fill="#1a1a1a" rx="8"/>
  <text x="1010" y="585" text-anchor="middle" fill="#ff9f40" font-family="Arial, sans-serif" font-size="12" font-weight="bold">
    Recovery Strategies
  </text>
  <text x="900" y="600" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Event replay from snapshots
  </text>
  <text x="900" y="615" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Incremental backup support
  </text>
  <text x="900" y="630" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Cross-platform export
  </text>
  <text x="900" y="645" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Deterministic state rebuild
  </text>
  <text x="900" y="660" fill="#ffffff" font-family="Arial, sans-serif" font-size="10">
    • Corruption detection & repair
  </text>
  
  <!-- Data Flow Arrows -->
  <line x1="330" y1="350" x2="375" y2="350" stroke="#6bcf7f" stroke-width="3" marker-end="url(#arrow)"/>
  <line x1="565" y1="350" x2="615" y2="350" stroke="#4d96ff" stroke-width="3" marker-end="url(#arrow)"/>
  <line x1="650" y1="350" x2="695" y2="350" stroke="#ffffff" stroke-width="3" marker-end="url(#arrow)"/>
  <line x1="785" y1="350" x2="865" y2="350" stroke="#ffd93d" stroke-width="3" marker-end="url(#arrow)"/>
  
  <!-- Event to Database -->
  <line x1="470" y1="240" x2="470" y2="275" stroke="#6bcf7f" stroke-width="3" marker-end="url(#arrow)"/>
  <line x1="600" y1="225" x2="600" y2="275" stroke="#4d96ff" stroke-width="3" marker-end="url(#arrow)"/>
  <line x1="730" y1="240" x2="730" y2="275" stroke="#ffd93d" stroke-width="3" marker-end="url(#arrow)"/>
  
  <!-- Audit connections -->
  <line x1="190" y1="485" x2="190" y2="515" stroke="#ff6b6b" stroke-width="3" marker-end="url(#arrow)"/>
  <line x1="470" y1="485" x2="470" y2="515" stroke="#9966ff" stroke-width="3" marker-end="url(#arrow)"/>
  <line x1="1010" y1="485" x2="1010" y2="515" stroke="#ff9f40" stroke-width="3" marker-end="url(#arrow)"/>
  
  <!-- Privacy & Security Box -->
  <rect x="50" y="720" width="1100" height="60" fill="#1a1a1a" rx="8" stroke="#333333" stroke-width="1"/>
  <text x="70" y="745" fill="#ffffff" font-family="Arial, sans-serif" font-size="14" font-weight="bold">
    Privacy & Security Guarantees:
  </text>
  <text x="70" y="765" fill="#ffffff" font-family="Arial, sans-serif" font-size="12">
    • Local-only storage (no cloud dependencies) • AES-256 encryption for sensitive data • Privacy-preserving event schema (no raw content) • GDPR-compliant data handling • User-controlled retention policies
  </text>
</svg>
