---
title: "WIRTHFORGE State Management System Architecture"
config:
  theme: dark
  themeVariables:
    primaryColor: "#4a90e2"
    primaryTextColor: "#ffffff"
    primaryBorderColor: "#2c5aa0"
    lineColor: "#61dafb"
    secondaryColor: "#f39c12"
    tertiaryColor: "#e74c3c"
    background: "#1a1a1a"
    mainBkg: "#2d2d2d"
    secondBkg: "#3d3d3d"
---

graph TB
    %% User Interface Layer
    subgraph UI["ğŸ–¥ï¸ User Interface Layer"]
        Browser["ğŸŒ Web Browser<br/>React/Vue Components"]
        Desktop["ğŸ–¥ï¸ Desktop App<br/>Electron/Tauri"]
        Mobile["ğŸ“± Mobile App<br/>React Native"]
    end

    %% WebSocket Communication Layer
    subgraph WS["ğŸ”Œ Real-time Communication"]
        WSServer["WebSocket Server<br/>ğŸ“¡ FastAPI/uvicorn<br/>Port: 8080"]
        WSConnections["Active Connections<br/>ğŸ‘¥ Multi-client support<br/>Event broadcasting"]
    end

    %% Core Application Layer
    subgraph CORE["âš¡ WIRTHFORGE Core System"]
        direction TB
        Orchestrator["ğŸ¯ System Orchestrator<br/>WF-TECH-001<br/>â€¢ Component lifecycle<br/>â€¢ Resource management<br/>â€¢ Error coordination"]
        
        Decipher["ğŸ§  Decipher Engine<br/>WF-FND-004<br/>â€¢ AI model management<br/>â€¢ Energy calculations<br/>â€¢ Pattern detection<br/>â€¢ 60Hz processing"]
        
        StateManager["ğŸ’¾ State Manager<br/>WF-TECH-004<br/>â€¢ Event sourcing<br/>â€¢ Real-time persistence<br/>â€¢ Crash recovery<br/>â€¢ Performance monitoring"]
    end

    %% State Management Subsystem Detail
    subgraph STATE["ğŸ—ï¸ State Management Subsystem (WF-TECH-004)"]
        direction TB
        
        subgraph MEMORY["ğŸ§  In-Memory State"]
            CurrentState["Current State<br/>ğŸ“Š Energy Accumulator<br/>ğŸ¯ Frame State<br/>ğŸ“ˆ Performance Metrics"]
            EventQueue["Event Queue<br/>ğŸ“¥ Async Buffer<br/>Max: 1000 events<br/>Batch: 15 events"]
        end
        
        subgraph PROCESSING["âš™ï¸ Event Processing"]
            EventValidator["Event Validator<br/>âœ… JSON Schema<br/>ğŸ” Data integrity<br/>âš¡ Real-time validation"]
            
            EventProcessor["Event Processor<br/>ğŸ”„ State updates<br/>ğŸ“Š Energy calculations<br/>ğŸ¯ Pattern detection"]
            
            SnapshotManager["Snapshot Manager<br/>ğŸ“¸ Periodic snapshots<br/>ğŸ”„ Recovery points<br/>â±ï¸ Every 1000 events"]
        end
        
        subgraph PERSISTENCE["ğŸ’¾ Persistence Layer"]
            BackgroundWriter["Background Writer<br/>ğŸ“ Async batching<br/>âš¡ Non-blocking<br/>ğŸ¯ 60Hz compliance"]
            
            Database["SQLite Database<br/>ğŸ—„ï¸ Local storage<br/>ğŸ“Š Event log<br/>ğŸ“¸ Snapshots<br/>ğŸ‘¤ User sessions"]
        end
    end

    %% Database Schema Detail
    subgraph DB["ğŸ—„ï¸ Database Schema"]
        direction LR
        UserTable["ğŸ‘¤ User Table<br/>â€¢ user_id (PK)<br/>â€¢ username<br/>â€¢ preferences<br/>â€¢ created_at"]
        
        SessionTable["ğŸ® Session Table<br/>â€¢ session_id (PK)<br/>â€¢ user_id (FK)<br/>â€¢ start_time<br/>â€¢ end_time<br/>â€¢ total_energy"]
        
        EventTable["ğŸ“ Event Table<br/>â€¢ event_id (PK)<br/>â€¢ session_id (FK)<br/>â€¢ timestamp<br/>â€¢ type<br/>â€¢ data (JSON)<br/>â€¢ energy_delta"]
        
        SnapshotTable["ğŸ“¸ Snapshot Table<br/>â€¢ snapshot_id (PK)<br/>â€¢ session_id (FK)<br/>â€¢ timestamp<br/>â€¢ state_data (JSON)<br/>â€¢ event_count"]
        
        AuditTable["ğŸ“‹ Audit Table<br/>â€¢ audit_id (PK)<br/>â€¢ session_id (FK)<br/>â€¢ action<br/>â€¢ timestamp<br/>â€¢ metadata"]
    end

    %% External Integrations
    subgraph EXTERNAL["ğŸ”— External Integrations"]
        ModelAPIs["ğŸ¤– AI Model APIs<br/>â€¢ Ollama (local)<br/>â€¢ OpenAI (optional)<br/>â€¢ Anthropic (optional)<br/>â€¢ Custom models"]
        
        FileSystem["ğŸ“ File System<br/>â€¢ Database files<br/>â€¢ Backup storage<br/>â€¢ Export files<br/>â€¢ Log files"]
        
        SystemMonitoring["ğŸ“Š System Monitoring<br/>â€¢ Performance metrics<br/>â€¢ Health checks<br/>â€¢ Error tracking<br/>â€¢ Resource usage"]
    end

    %% Data Flow Connections
    UI --> WSServer
    WSServer --> WSConnections
    WSConnections --> Orchestrator
    
    Orchestrator --> Decipher
    Orchestrator --> StateManager
    Decipher --> StateManager
    
    StateManager --> CurrentState
    StateManager --> EventQueue
    
    EventQueue --> EventValidator
    EventValidator --> EventProcessor
    EventProcessor --> CurrentState
    EventProcessor --> SnapshotManager
    EventProcessor --> BackgroundWriter
    
    BackgroundWriter --> Database
    SnapshotManager --> Database
    
    Database --> UserTable
    Database --> SessionTable
    Database --> EventTable
    Database --> SnapshotTable
    Database --> AuditTable
    
    StateManager --> FileSystem
    StateManager --> SystemMonitoring
    Decipher --> ModelAPIs
    
    %% Real-time feedback loops
    CurrentState -.->|State Updates| WSConnections
    EventProcessor -.->|Pattern Events| Decipher
    Database -.->|Recovery Data| StateManager
    SystemMonitoring -.->|Health Status| Orchestrator

    %% Styling
    classDef uiClass fill:#4a90e2,stroke:#2c5aa0,stroke-width:2px,color:#fff
    classDef coreClass fill:#e74c3c,stroke:#c0392b,stroke-width:2px,color:#fff
    classDef stateClass fill:#27ae60,stroke:#229954,stroke-width:2px,color:#fff
    classDef dbClass fill:#f39c12,stroke:#e67e22,stroke-width:2px,color:#fff
    classDef externalClass fill:#9b59b6,stroke:#8e44ad,stroke-width:2px,color:#fff
    classDef memoryClass fill:#1abc9c,stroke:#16a085,stroke-width:2px,color:#fff
    classDef processClass fill:#34495e,stroke:#2c3e50,stroke-width:2px,color:#fff
    classDef persistClass fill:#e67e22,stroke:#d35400,stroke-width:2px,color:#fff

    class Browser,Desktop,Mobile uiClass
    class Orchestrator,Decipher,StateManager coreClass
    class EventValidator,EventProcessor,SnapshotManager,BackgroundWriter stateClass
    class UserTable,SessionTable,EventTable,SnapshotTable,AuditTable,Database dbClass
    class ModelAPIs,FileSystem,SystemMonitoring externalClass
    class CurrentState,EventQueue memoryClass
    class WSServer,WSConnections processClass
