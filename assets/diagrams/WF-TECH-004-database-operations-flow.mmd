---
title: "Database Operations & Performance Flow"
config:
  theme: dark
  themeVariables:
    primaryColor: "#feca57"
    primaryTextColor: "#ffffff"
    primaryBorderColor: "#f39c12"
    lineColor: "#00ff88"
    secondaryColor: "#4a90e2"
    tertiaryColor: "#e74c3c"
    background: "#0d1117"
    mainBkg: "#161b22"
    secondBkg: "#21262d"
---

graph TD
    %% Application Layer
    subgraph APP["ğŸš€ Application Layer"]
        StateManager["ğŸ’¾ State Manager<br/>â€¢ Event coordination<br/>â€¢ Memory management<br/>â€¢ Performance monitoring"]
        
        EventProcessor["âš™ï¸ Event Processor<br/>â€¢ JSON validation<br/>â€¢ Schema compliance<br/>â€¢ Batch coordination"]
        
        BackgroundWriter["ğŸ“ Background Writer<br/>â€¢ Async operations<br/>â€¢ Batch optimization<br/>â€¢ Error handling"]
    end

    %% Connection Pool & Management
    subgraph CONN["ğŸ”— Connection Management"]
        ConnPool["Connection Pool<br/>ğŸ“Š Max: 10 connections<br/>â±ï¸ Timeout: 30s<br/>ğŸ”„ Reuse optimization"]
        
        TransactionMgr["Transaction Manager<br/>ğŸ”’ ACID compliance<br/>ğŸ“Š Batch transactions<br/>ğŸ”„ Rollback handling"]
        
        LockManager["Lock Manager<br/>ğŸ” Row-level locking<br/>â±ï¸ Deadlock detection<br/>ğŸ”„ Retry logic"]
    end

    %% Database Engine
    subgraph DB["ğŸ—„ï¸ SQLite Database Engine"]
        direction TB
        
        subgraph TABLES["ğŸ“Š Table Operations"]
            UserOps["ğŸ‘¤ User Operations<br/>â€¢ INSERT user<br/>â€¢ UPDATE preferences<br/>â€¢ SELECT profile"]
            
            SessionOps["ğŸ® Session Operations<br/>â€¢ INSERT session<br/>â€¢ UPDATE totals<br/>â€¢ SELECT active"]
            
            EventOps["ğŸ“ Event Operations<br/>â€¢ BATCH INSERT events<br/>â€¢ SELECT by timestamp<br/>â€¢ INDEX optimization"]
            
            SnapshotOps["ğŸ“¸ Snapshot Operations<br/>â€¢ INSERT snapshot<br/>â€¢ SELECT latest<br/>â€¢ DELETE old"]
            
            AuditOps["ğŸ“‹ Audit Operations<br/>â€¢ INSERT audit log<br/>â€¢ SELECT by session<br/>â€¢ VACUUM cleanup"]
        end
        
        subgraph INDEXES["ğŸ” Index Management"]
            PrimaryIdx["Primary Indexes<br/>ğŸ”‘ user_id, session_id<br/>ğŸ”‘ event_id, snapshot_id<br/>âš¡ O(log n) lookup"]
            
            TimeIdx["Timestamp Indexes<br/>â±ï¸ event.timestamp<br/>â±ï¸ session.start_time<br/>ğŸ“Š Range queries"]
            
            CompositeIdx["Composite Indexes<br/>ğŸ”— (session_id, timestamp)<br/>ğŸ”— (user_id, session_id)<br/>ğŸ¯ Multi-column queries"]
        end
        
        subgraph STORAGE["ğŸ’¾ Storage Engine"]
            PageCache["Page Cache<br/>ğŸ“„ 4KB pages<br/>ğŸ’¾ LRU eviction<br/>ğŸ¯ Hot data priority"]
            
            WAL["Write-Ahead Log<br/>ğŸ“ Durability guarantee<br/>ğŸ”„ Crash recovery<br/>âš¡ Concurrent reads"]
            
            Vacuum["VACUUM Operations<br/>ğŸ§¹ Space reclamation<br/>ğŸ“Š Statistics update<br/>â±ï¸ Scheduled maintenance"]
        end
    end

    %% Performance Monitoring
    subgraph PERF["ğŸ“Š Performance Monitoring"]
        QueryAnalyzer["Query Analyzer<br/>ğŸ“ˆ Execution plans<br/>â±ï¸ Timing analysis<br/>ğŸ¯ Bottleneck detection"]
        
        MetricsCollector["Metrics Collector<br/>ğŸ“Š Operation counts<br/>â±ï¸ Latency tracking<br/>ğŸ’¾ Memory usage"]
        
        AlertSystem["Alert System<br/>ğŸš¨ Threshold monitoring<br/>ğŸ“§ Notification system<br/>ğŸ”„ Auto-recovery"]
    end

    %% Data Flow
    StateManager --> EventProcessor
    EventProcessor --> BackgroundWriter
    BackgroundWriter --> ConnPool
    
    ConnPool --> TransactionMgr
    TransactionMgr --> LockManager
    LockManager --> UserOps
    LockManager --> SessionOps
    LockManager --> EventOps
    LockManager --> SnapshotOps
    LockManager --> AuditOps
    
    UserOps --> PrimaryIdx
    SessionOps --> PrimaryIdx
    EventOps --> TimeIdx
    SnapshotOps --> CompositeIdx
    AuditOps --> CompositeIdx
    
    PrimaryIdx --> PageCache
    TimeIdx --> PageCache
    CompositeIdx --> PageCache
    
    PageCache --> WAL
    WAL --> Vacuum
    
    %% Monitoring connections
    ConnPool -.-> MetricsCollector
    TransactionMgr -.-> QueryAnalyzer
    EventOps -.-> AlertSystem
    PageCache -.-> MetricsCollector

    %% Detailed Operation Flows
    subgraph BATCH_FLOW["ğŸ“¦ Batch Write Flow"]
        direction LR
        BatchCollect["Collect Events<br/>ğŸ“¥ Queue: 15 events<br/>â±ï¸ Timeout: 200ms<br/>ğŸ¯ Optimal batch size"]
        
        BatchValidate["Validate Batch<br/>âœ… JSON schemas<br/>ğŸ” Foreign keys<br/>âš–ï¸ Energy conservation"]
        
        BatchWrite["Write Batch<br/>ğŸ”’ BEGIN TRANSACTION<br/>ğŸ“ INSERT batch<br/>âœ… COMMIT"]
        
        BatchCollect --> BatchValidate
        BatchValidate --> BatchWrite
    end

    subgraph QUERY_FLOW["ğŸ” Query Optimization Flow"]
        direction LR
        QueryPlan["Query Planning<br/>ğŸ“‹ Analyze query<br/>ğŸ” Index selection<br/>ğŸ“Š Cost estimation"]
        
        QueryExec["Query Execution<br/>âš¡ Index scan<br/>ğŸ“„ Page reads<br/>ğŸ¯ Result assembly"]
        
        QueryCache["Result Caching<br/>ğŸ’¾ Query cache<br/>â±ï¸ TTL: 60s<br/>ğŸ”„ Invalidation"]
        
        QueryPlan --> QueryExec
        QueryExec --> QueryCache
    end

    BackgroundWriter --> BatchCollect
    EventOps --> QueryPlan

    %% Performance Specifications
    subgraph SPECS["ğŸ¯ Performance Specifications"]
        WriteSpecs["Write Performance<br/>ğŸ“ Batch: 15 events<br/>â±ï¸ Latency: <20ms p99<br/>ğŸ”„ Throughput: 750 events/s<br/>ğŸ’¾ Queue: <500 events"]
        
        ReadSpecs["Read Performance<br/>ğŸ” Recent queries: <100ms<br/>ğŸ“Š Session load: <2s<br/>ğŸ” Search: <500ms<br/>ğŸ“ˆ Index usage: >95%"]
        
        StorageSpecs["Storage Efficiency<br/>ğŸ’¾ Compression: ~60%<br/>ğŸ§¹ VACUUM: weekly<br/>ğŸ“Š Growth: <1MB/10K events<br/>ğŸ”„ Retention: 90 days"]
    end

    %% Error Handling & Recovery
    subgraph ERROR["ğŸš¨ Error Handling"]
        RetryLogic["Retry Logic<br/>ğŸ”„ Max attempts: 3<br/>â±ï¸ Backoff: exponential<br/>ğŸ¯ Circuit breaker"]
        
        ErrorRecovery["Error Recovery<br/>ğŸ”„ Transaction rollback<br/>ğŸ’¾ State restoration<br/>ğŸ“‹ Error logging"]
        
        Degradation["Graceful Degradation<br/>ğŸ’¾ Memory-only mode<br/>ğŸ“Š Reduced functionality<br/>ğŸš¨ User notification"]
        
        RetryLogic --> ErrorRecovery
        ErrorRecovery --> Degradation
    end

    TransactionMgr --> RetryLogic
    BackgroundWriter --> RetryLogic

    %% Maintenance Operations
    subgraph MAINT["ğŸ”§ Maintenance Operations"]
        AutoVacuum["Auto VACUUM<br/>ğŸ§¹ Triggered at 25% fragmentation<br/>â±ï¸ Scheduled during low usage<br/>ğŸ“Š Statistics update"]
        
        IndexMaint["Index Maintenance<br/>ğŸ” REINDEX on corruption<br/>ğŸ“Š ANALYZE for statistics<br/>ğŸ¯ Performance optimization"]
        
        Backup["Backup Operations<br/>ğŸ’¾ Full backup: daily<br/>ğŸ“ Incremental: hourly<br/>ğŸ”„ Point-in-time recovery"]
        
        AutoVacuum --> IndexMaint
        IndexMaint --> Backup
    end

    Vacuum --> AutoVacuum
    PageCache --> IndexMaint

    %% Real-time Metrics
    note1["Real-time Metrics:<br/>â€¢ Write latency: p50, p95, p99<br/>â€¢ Query execution time<br/>â€¢ Connection pool usage<br/>â€¢ Cache hit ratio<br/>â€¢ Queue depth<br/>â€¢ Error rates"]
    
    note2["Optimization Targets:<br/>â€¢ Index selectivity > 0.1<br/>â€¢ Cache hit ratio > 90%<br/>â€¢ Transaction time < 50ms<br/>â€¢ Lock wait time < 10ms<br/>â€¢ Page fault rate < 1%"]
    
    note3["Scaling Limits:<br/>â€¢ Max connections: 10<br/>â€¢ Max database size: 10GB<br/>â€¢ Max events/session: 1M<br/>â€¢ Max concurrent sessions: 100<br/>â€¢ Max queue depth: 1000"]

    %% Styling
    classDef appClass fill:#4a90e2,stroke:#2c5aa0,stroke-width:2px,color:#fff
    classDef connClass fill:#27ae60,stroke:#229954,stroke-width:2px,color:#fff
    classDef dbClass fill:#f39c12,stroke:#e67e22,stroke-width:2px,color:#fff
    classDef perfClass fill:#e74c3c,stroke:#c0392b,stroke-width:2px,color:#fff
    classDef flowClass fill:#9b59b6,stroke:#8e44ad,stroke-width:2px,color:#fff
    classDef errorClass fill:#ff6b6b,stroke:#e55656,stroke-width:2px,color:#fff
    classDef maintClass fill:#1abc9c,stroke:#16a085,stroke-width:2px,color:#fff

    class StateManager,EventProcessor,BackgroundWriter appClass
    class ConnPool,TransactionMgr,LockManager connClass
    class UserOps,SessionOps,EventOps,SnapshotOps,AuditOps,PrimaryIdx,TimeIdx,CompositeIdx,PageCache,WAL,Vacuum dbClass
    class QueryAnalyzer,MetricsCollector,AlertSystem perfClass
    class BatchCollect,BatchValidate,BatchWrite,QueryPlan,QueryExec,QueryCache flowClass
    class RetryLogic,ErrorRecovery,Degradation errorClass
    class AutoVacuum,IndexMaint,Backup maintClass
