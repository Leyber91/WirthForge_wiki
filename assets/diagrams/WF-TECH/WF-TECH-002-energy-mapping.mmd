flowchart TD
    subgraph INPUT["ğŸ¯ TOKEN STREAM INPUT"]
        T["ğŸ­ Token Generated<br/>('Hello', 'world', '!')"]
        TM["ğŸ“Š Token Metadata<br/>(logprobs, position, model)"]
        TS["â±ï¸ Timestamp Î”t<br/>(generation timing)"]
    end
    
    subgraph PIPELINE["âš¡ ENERGY CALCULATION PIPELINE"]
        subgraph TIMING["ğŸ• TIMING ANALYSIS"]
            DT["ğŸ“ Delta Time Î”t<br/>(ms between tokens)"]
            TPS["ğŸš€ Tokens Per Second<br/>(generation speed)"]
            TTFT["âš¡ Time to First Token<br/>(TTFT latency)"]
        end
        
        subgraph SEMANTIC["ğŸ§  SEMANTIC ANALYSIS"]
            LP["ğŸ“ˆ Log Probabilities<br/>(model confidence)"]
            ENT["ğŸŒ€ Entropy Calculation<br/>(uncertainty measure)"]
            TK["ğŸ² Top-K Diversity<br/>(choice breadth)"]
        end
        
        subgraph FORMULA["ğŸ§® ENERGY FORMULA"]
            EF["âš¡ E(t) = wâ‚Ã—E_cadence + wâ‚‚Ã—E_certainty + wâ‚ƒÃ—E_stall<br/>ğŸ”¬ Physics-Based Energy Computation"]
            NORM["ğŸ“ Normalize to [0,1]<br/>(energy bounds)"]
            SMOOTH["ğŸ“Š Exponential Moving Average<br/>(Î±=0.1, smooth visualization)"]
        end
    end
    
    subgraph OUTPUT["ğŸ“¡ OUTPUT EVENTS (60Hz)"]
        EU["ğŸŒŠ Energy Update<br/>(real-time E(t))"]
        TS_OUT["ğŸ­ Token Stream<br/>(with energy values)"]
        FM["ğŸ“Š Frame Metrics<br/>(performance data)"]
    end
    
    subgraph MULTI["ğŸª MULTI-MODEL PROCESSING"]
        subgraph TURBO["ğŸš€ TURBO MODE"]
            M1["ğŸ¤– Model 1: LLaMA2-7B<br/>(primary generation)"]
            M2["ğŸ¤– Model 2: CodeLLaMA<br/>(code specialist)"] 
            M3["ğŸ¤– Model 3: Mistral-7B<br/>(reasoning expert)"]
        end
        
        subgraph ENSEMBLE["ğŸ”¬ ENSEMBLE ANALYSIS"]
            INT["ğŸŒŠ Interference Pattern<br/>(model disagreement)"]
            RES["ğŸµ Resonance Detection<br/>(model synchronization)"]
            DIV["ğŸ“Š Diversity Index<br/>DI = 1 - max(P_i)"]
        end
        
        subgraph COUNCIL["ğŸ›ï¸ COUNCIL EVENTS"]
            IE["âš¡ interference_event<br/>(visual interference)"]
            RE["âœ¨ resonance_event<br/>(celebration trigger)"]
            EE["ğŸŒŸ ensemble_energy<br/>(combined E(t))"]
        end
    end
    
    %% Enhanced Flow Connections
    T -.->|"ğŸ¯ Raw Token"| DT
    TM -.->|"ğŸ“Š Metadata"| LP
    TS -.->|"â±ï¸ Timing"| TPS
    
    DT -->|"âš¡ Speed Component"| EF
    LP -->|"ğŸ§  Confidence"| ENT
    ENT -->|"ğŸŒ€ Uncertainty"| EF
    TPS -->|"ğŸš€ Cadence"| TK
    TK -->|"ğŸ² Diversity"| EF
    
    EF -->|"ğŸ§® Raw Energy"| NORM
    NORM -->|"ğŸ“ Bounded [0,1]"| SMOOTH
    SMOOTH -->|"ğŸ“Š Smoothed E(t)"| EU
    T -->|"ğŸ­ Original Token"| TS_OUT
    EU -->|"âš¡ Energy Data"| FM
    
    %% Multi-Model Enhanced Flow
    M1 -.->|"ğŸ¤– Stream A"| INT
    M2 -.->|"ğŸ¤– Stream B"| INT
    M3 -.->|"ğŸ¤– Stream C"| INT
    
    INT -->|"ğŸŒŠ Pattern Analysis"| DIV
    M1 -.->|"ğŸµ Sync Check"| RES
    M2 -.->|"ğŸµ Sync Check"| RES
    M3 -.->|"ğŸµ Sync Check"| RES
    
    DIV -->|"ğŸ“Š High Diversity"| IE
    RES -->|"âœ¨ Synchronization"| RE
    INT -->|"ğŸŒŸ Combined Energy"| EE
    
    %% Visual Enhancement Styling
    style EF fill:#ff9800,stroke:#f57c00,stroke-width:3px,color:#fff
    style EU fill:#4caf50,stroke:#388e3c,stroke-width:3px,color:#fff
    style INT fill:#e91e63,stroke:#c2185b,stroke-width:3px,color:#fff
    style RES fill:#9c27b0,stroke:#7b1fa2,stroke-width:3px,color:#fff
    style FORMULA fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style TURBO fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    style COUNCIL fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    style INPUT fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    style OUTPUT fill:#fff8e1,stroke:#ffc107,stroke-width:2px
