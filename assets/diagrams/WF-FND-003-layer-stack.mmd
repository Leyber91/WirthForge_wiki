graph TB
    subgraph "WIRTHFORGE Five-Layer Architecture"
        direction TB
        
        subgraph L5["🎨 Layer 5: Visualization & UX"]
            L5_UI["User Interface Components"]
            L5_VIS["Visual Effects Engine"]
            L5_INT["Interaction Handler"]
            L5_PROG["Progressive Complexity Manager"]
        end
        
        subgraph L4["🌐 Layer 4: Contracts & Transport"]
            L4_WS["WebSocket Server"]
            L4_API["REST API Gateway"]
            L4_AUTH["Authentication & Security"]
            L4_SCHEMA["Schema Validation"]
        end
        
        subgraph L3["🧠 Layer 3: Orchestration & Energy"]
            L3_ORCH["Model Orchestrator"]
            L3_ENERGY["Energy Calculator"]
            L3_STATE["State Manager (60Hz)"]
            L3_EVENTS["Event Publisher"]
        end
        
        subgraph L2["⚡ Layer 2: Model Compute"]
            L2_LOCAL["Local Model Runner (Ollama)"]
            L2_PARALLEL["Parallel Execution Manager"]
            L2_REMOTE["Remote Satellite (Optional)"]
            L2_STREAM["Token Stream Handler"]
        end
        
        subgraph L1["🔐 Layer 1: Input & Identity"]
            L1_VALID["Input Validator"]
            L1_ID["Identity Manager"]
            L1_SESSION["Session Handler"]
            L1_NORM["Input Normalizer"]
        end
    end
    
    %% Data Flow Connections
    L5_INT -->|"User Actions (JSON)"| L4_API
    L4_API -->|"Validated Requests"| L1_VALID
    L1_ID -->|"Input Events"| L3_ORCH
    L3_ORCH -->|"Model Requests"| L2_LOCAL
    L2_STREAM -->|"Token Streams"| L3_ENERGY
    L3_EVENTS -->|"Energy Events"| L4_WS
    L4_WS -->|"Real-time Updates"| L5_VIS
    
    %% Parallel Model Flow
    L3_ORCH -->|"Council Requests"| L2_PARALLEL
    L2_PARALLEL -->|"Multi-stream Tokens"| L3_ENERGY
    
    %% Optional Remote Flow
    L3_ORCH -.->|"Large Model Requests"| L2_REMOTE
    L2_REMOTE -.->|"Remote Token Stream"| L3_ENERGY
    
    %% State Management
    L3_STATE -->|"State Updates (60Hz)"| L3_EVENTS
    L3_ENERGY -->|"EU Calculations"| L3_STATE
    
    %% Progressive Complexity
    L3_STATE -->|"Level Progression"| L4_SCHEMA
    L4_SCHEMA -->|"UI Level Events"| L5_PROG
    
    %% Color Coding
    classDef layer1 fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef layer2 fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef layer3 fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef layer4 fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef layer5 fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef optional fill:#f5f5f5,stroke:#757575,stroke-width:1px,stroke-dasharray: 5 5
    
    class L1,L1_VALID,L1_ID,L1_SESSION,L1_NORM layer1
    class L2,L2_LOCAL,L2_PARALLEL,L2_STREAM layer2
    class L2_REMOTE optional
    class L3,L3_ORCH,L3_ENERGY,L3_STATE,L3_EVENTS layer3
    class L4,L4_WS,L4_API,L4_AUTH,L4_SCHEMA layer4
    class L5,L5_UI,L5_VIS,L5_INT,L5_PROG layer5
