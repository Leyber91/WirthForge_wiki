flowchart TD
    subgraph INPUT["🎯 TOKEN STREAM INPUT"]
        T["🎭 Token Generated<br/>('Hello', 'world', '!')"]
        TM["📊 Token Metadata<br/>(logprobs, position, model)"]
        TS["⏱️ Timestamp Δt<br/>(generation timing)"]
    end
    
    subgraph PIPELINE["⚡ ENERGY CALCULATION PIPELINE"]
        subgraph TIMING["🕐 TIMING ANALYSIS"]
            DT["📏 Delta Time Δt<br/>(ms between tokens)"]
            TPS["🚀 Tokens Per Second<br/>(generation speed)"]
            TTFT["⚡ Time to First Token<br/>(TTFT latency)"]
        end
        
        subgraph SEMANTIC["🧠 SEMANTIC ANALYSIS"]
            LP["📈 Log Probabilities<br/>(model confidence)"]
            ENT["🌀 Entropy Calculation<br/>(uncertainty measure)"]
            TK["🎲 Top-K Diversity<br/>(choice breadth)"]
        end
        
        subgraph FORMULA["🧮 ENERGY FORMULA"]
            EF["⚡ E(t) = w₁×E_cadence + w₂×E_certainty + w₃×E_stall<br/>🔬 Physics-Based Energy Computation"]
            NORM["📐 Normalize to [0,1]<br/>(energy bounds)"]
            SMOOTH["📊 Exponential Moving Average<br/>(α=0.1, smooth visualization)"]
        end
    end
    
    subgraph OUTPUT["📡 OUTPUT EVENTS (60Hz)"]
        EU["🌊 Energy Update<br/>(real-time E(t))"]
        TS_OUT["🎭 Token Stream<br/>(with energy values)"]
        FM["📊 Frame Metrics<br/>(performance data)"]
    end
    
    subgraph MULTI["🎪 MULTI-MODEL PROCESSING"]
        subgraph TURBO["🚀 TURBO MODE"]
            M1["🤖 Model 1: LLaMA2-7B<br/>(primary generation)"]
            M2["🤖 Model 2: CodeLLaMA<br/>(code specialist)"] 
            M3["🤖 Model 3: Mistral-7B<br/>(reasoning expert)"]
        end
        
        subgraph ENSEMBLE["🔬 ENSEMBLE ANALYSIS"]
            INT["🌊 Interference Pattern<br/>(model disagreement)"]
            RES["🎵 Resonance Detection<br/>(model synchronization)"]
            DIV["📊 Diversity Index<br/>DI = 1 - max(P_i)"]
        end
        
        subgraph COUNCIL["🏛️ COUNCIL EVENTS"]
            IE["⚡ interference_event<br/>(visual interference)"]
            RE["✨ resonance_event<br/>(celebration trigger)"]
            EE["🌟 ensemble_energy<br/>(combined E(t))"]
        end
    end
    
    %% Enhanced Flow Connections
    T -.->|"🎯 Raw Token"| DT
    TM -.->|"📊 Metadata"| LP
    TS -.->|"⏱️ Timing"| TPS
    
    DT -->|"⚡ Speed Component"| EF
    LP -->|"🧠 Confidence"| ENT
    ENT -->|"🌀 Uncertainty"| EF
    TPS -->|"🚀 Cadence"| TK
    TK -->|"🎲 Diversity"| EF
    
    EF -->|"🧮 Raw Energy"| NORM
    NORM -->|"📐 Bounded [0,1]"| SMOOTH
    SMOOTH -->|"📊 Smoothed E(t)"| EU
    T -->|"🎭 Original Token"| TS_OUT
    EU -->|"⚡ Energy Data"| FM
    
    %% Multi-Model Enhanced Flow
    M1 -.->|"🤖 Stream A"| INT
    M2 -.->|"🤖 Stream B"| INT
    M3 -.->|"🤖 Stream C"| INT
    
    INT -->|"🌊 Pattern Analysis"| DIV
    M1 -.->|"🎵 Sync Check"| RES
    M2 -.->|"🎵 Sync Check"| RES
    M3 -.->|"🎵 Sync Check"| RES
    
    DIV -->|"📊 High Diversity"| IE
    RES -->|"✨ Synchronization"| RE
    INT -->|"🌟 Combined Energy"| EE
    
    %% Visual Enhancement Styling
    style EF fill:#ff9800,stroke:#f57c00,stroke-width:3px,color:#fff
    style EU fill:#4caf50,stroke:#388e3c,stroke-width:3px,color:#fff
    style INT fill:#e91e63,stroke:#c2185b,stroke-width:3px,color:#fff
    style RES fill:#9c27b0,stroke:#7b1fa2,stroke-width:3px,color:#fff
    style FORMULA fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    style TURBO fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    style COUNCIL fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    style INPUT fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    style OUTPUT fill:#fff8e1,stroke:#ffc107,stroke-width:2px
