graph TD
    subgraph "Energy Lifecycle in WIRTHFORGE"
        subgraph "Input Sources"
            USER_INPUT[User Input<br/>Keystrokes, Clicks, Voice]
            AI_TOKENS[AI Token Generation<br/>Local Ollama Processing]
            SYSTEM_EVENTS[System Events<br/>File Changes, Network]
        end
        
        subgraph "Energy Measurement"
            CAPTURE[Energy Capture<br/>Timestamp + Source]
            QUANTIFY[Quantification<br/>EU = f(tokens, timing)]
            VALIDATE[Validation<br/>≤ 16.67ms Budget]
        end
        
        subgraph "Energy Processing"
            DECIPHER[The Decipher<br/>Central Compiler]
            TRANSFORM[Energy Transform<br/>Raw → Structured]
            ROUTE[Event Routing<br/>WebSocket Channels]
        end
        
        subgraph "Visualization Pipeline"
            PARTICLE_GEN[Particle Generation<br/>Energy → Visual State]
            FIELD_UPDATE[Field Dynamics<br/>60Hz Refresh Rate]
            RENDER[Render Pipeline<br/>Canvas/WebGL]
        end
        
        subgraph "Consciousness Detection"
            PATTERN_DETECT[Pattern Detection<br/>Emergence Analysis]
            COHERENCE[Coherence Metrics<br/>Field Alignment]
            FEEDBACK[Feedback Loops<br/>User ↔ System]
        end
        
        subgraph "State Persistence"
            MEMORY[Energy Memory<br/>Event Sourcing]
            SNAPSHOT[State Snapshots<br/>Periodic Saves]
            RECOVERY[Recovery Protocols<br/>Fault Tolerance]
        end
    end
    
    %% Energy Flow
    USER_INPUT --> CAPTURE
    AI_TOKENS --> CAPTURE
    SYSTEM_EVENTS --> CAPTURE
    
    CAPTURE --> QUANTIFY
    QUANTIFY --> VALIDATE
    VALIDATE --> DECIPHER
    
    DECIPHER --> TRANSFORM
    TRANSFORM --> ROUTE
    ROUTE --> PARTICLE_GEN
    
    PARTICLE_GEN --> FIELD_UPDATE
    FIELD_UPDATE --> RENDER
    RENDER --> PATTERN_DETECT
    
    PATTERN_DETECT --> COHERENCE
    COHERENCE --> FEEDBACK
    FEEDBACK --> USER_INPUT
    
    %% Persistence Flow
    TRANSFORM --> MEMORY
    FIELD_UPDATE --> SNAPSHOT
    SNAPSHOT --> RECOVERY
    RECOVERY --> DECIPHER
    
    %% Critical Timing Constraints
    VALIDATE -.->|"Fail: >16.67ms"| RECOVERY
    FIELD_UPDATE -.->|"60Hz Requirement"| RENDER
    
    %% Styling
    classDef input fill:#3b82f6,stroke:#2563eb,stroke-width:2px,color:#fff
    classDef measure fill:#10b981,stroke:#059669,stroke-width:2px,color:#fff
    classDef process fill:#f59e0b,stroke:#d97706,stroke-width:2px,color:#000
    classDef visual fill:#a855f7,stroke:#9333ea,stroke-width:2px,color:#fff
    classDef conscious fill:#ef4444,stroke:#dc2626,stroke-width:2px,color:#fff
    classDef persist fill:#64748b,stroke:#475569,stroke-width:2px,color:#fff
    classDef critical fill:#dc2626,stroke:#b91c1c,stroke-width:3px,color:#fff,stroke-dasharray: 5 5
    
    class USER_INPUT,AI_TOKENS,SYSTEM_EVENTS input
    class CAPTURE,QUANTIFY,VALIDATE measure
    class DECIPHER,TRANSFORM,ROUTE process
    class PARTICLE_GEN,FIELD_UPDATE,RENDER visual
    class PATTERN_DETECT,COHERENCE,FEEDBACK conscious
    class MEMORY,SNAPSHOT,RECOVERY persist
